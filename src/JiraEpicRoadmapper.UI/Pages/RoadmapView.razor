@page "/"
@using JiraEpicRoadmapper.UI.Repositories
@using JiraEpicRoadmapper.Contracts
@using JiraEpicRoadmapper.UI.Models
@using System.Threading
@inject IEpicsRepository Repository;
@inject IJSRuntime JsRuntime;

@if (_errors == null && _epics == null)
{
    <LoadingBar Id="mainLoadingBar" Label="Loading..." />
}

@if (_errors != null)
{
    <ErrorPanel Errors="@_errors" />
}

@if (_epics != null)
{
    <ControlPanel SelectedBlock="@SelectedBlock"/>
    <EpicsPanel Epics="@_epics" OnScrollToTodayRequest="ScrollToToday" OnCardSelect="HandleCardSelect"/>
}

@code {
    private Epic[] _epics;
    private string _errors;
    //TODO: test
    public EpicVisualBlock SelectedBlock { get; private set; }


    protected override async Task OnInitializedAsync()
    {
        await RefreshEpics();
    }

    private async Task RefreshEpics()
    {
        _epics = null;
        _errors = null;
        try
        {
            _epics = await Repository.FetchEpics();
        }
        catch (Exception e)
        {
            SetError(e.Message);
        }
    }

    private void SetError(string error)
    {
        _errors = $"Unable to load epics, here is panda instead: 🐼\n\nFailure reason:\n{error}";
    }

    private async Task ScrollToToday(int xPosition)
    {
        await JsRuntime.InvokeVoidAsync("scroll", CancellationToken.None, xPosition - LayoutSettings.DaySpan, 0);
    }

    private void HandleCardSelect(EpicVisualBlock card)
    {
        SelectedBlock = card;
    }

}